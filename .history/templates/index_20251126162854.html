<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ­¦æ±‰å¸‚æ•°æ®ç®¡ç†ç³»ç»Ÿ - é«˜å¾·åœ°å›¾ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #container { height: 500px; margin-top: 10px; }
        .query-panel { background: #f8f9fa; padding: 15px; border-radius: 5px; }
        .result-item { border-bottom: 1px solid #eee; padding: 6px 0; }
        .status-hint {
            font-size: 0.875rem;
            color: #e67700;
            margin-top: 6px;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2 class="text-center mb-4">æ­¦æ±‰å¸‚ä¸»åŸåŒºæ•°æ®ç®¡ç†ç³»ç»Ÿ</h2>

    <div class="row">
        <!-- æŸ¥è¯¢é¢æ¿ -->
        <div class="col-md-4">
            <div class="query-panel">
                <h5>å±æ€§æŸ¥è¯¢</h5>
                <input type="text" id="keyword" class="form-control mb-2" placeholder="è¾“å…¥å…³é”®è¯ï¼Œå¦‚'å­¦æ ¡'">
                <button class="btn btn-primary btn-sm" onclick="searchByKeyword()">æœç´¢</button>
            </div>

            <div class="query-panel mt-3">
                <h5>èŒƒå›´æŸ¥è¯¢</h5>
                <button class="btn btn-warning btn-sm mb-2" onclick="startRangeQuery()">
                    ğŸ–±ï¸ å¼€å§‹æ¡†é€‰
                </button>
                <div id="rangeHint" class="status-hint" style="display:none;">
                    è¯·åœ¨åœ°å›¾ä¸ŠæŒ‰ä½é¼ æ ‡æ‹–æ‹½ç»˜åˆ¶åŒºåŸŸ...
                </div>
                <button class="btn btn-success btn-sm" onclick="clearMarkers()">æ¸…é™¤ç»“æœ</button>
            </div>
        </div>

        <!-- åœ°å›¾å®¹å™¨ -->
        <div class="col-md-8">
            <div id="container"></div>
        </div>
    </div>

    <!-- æŸ¥è¯¢ç»“æœåˆ—è¡¨ -->
    <div class="mt-4" id="results"></div>
</div>

<!-- å¼•å…¥é«˜å¾·åœ°å›¾ JS APIï¼Œå¯†é’¥å¦‚æœä¸å¯ç”¨ï¼Œè¯·è‡ªå·±ç”³è¯·é«˜å¾·çš„â€œWebç«¯(JS API)â€çš„å¯†é’¥ -->
<script src="https://webapi.amap.com/maps?v=2.0&key=7c0ba95a8d12a0dc0acf27f7772702ac"></script>
<script>
// ====== åˆå§‹åŒ–åœ°å›¾ ======
let map = new AMap.Map('container', {
    zoom: 11,
    center: [114.3, 30.58], // æ­¦æ±‰ä¸­å¿ƒ
    viewMode: '2D'
});

let currentMarkers = [];
let infoWindow = new AMap.InfoWindow({ offset: new AMap.Pixel(0, -10) });
let rectangleTool = null;
let isSelecting = false;
let startPoint = null;

// ====== åŠ è½½åˆå§‹POIæ•°æ® ======
fetch('/api/search?q=')
    .then(res => res.json())
    .then(data => addMarkers(data));

// æ·»åŠ æ ‡è®°åˆ°åœ°å›¾
function addMarkers(pois) {
    clearMarkers();
    let markers = [];
    pois.forEach(poi => {
        const marker = new AMap.Marker({
            position: [poi.lon, poi.lat],
            title: poi.name
        });

        const content = `<div><strong>${poi.name}</strong><br>${poi.type} | ${poi.district}</div>`;

        marker.on('click', () => {
            infoWindow.setContent(content);
            infoWindow.open(map, marker.getPosition());
        });

        marker.setMap(map);
        markers.push(marker);
    });
    currentMarkers = markers;

    if (pois.length > 0) {
        const bounds = new AMap.Bounds();
        pois.forEach(p => bounds.extend([p.lon, p.lat]));
        map.setBounds(bounds, 50);
    }
}

// å±æ€§æŸ¥è¯¢
function searchByKeyword() {
    const q = document.getElementById('keyword').value.trim();
    if (!q) return;
    fetch(`/api/search?q=${encodeURIComponent(q)}`)
        .then(res => res.json())
        .then(data => {
            addMarkers(data);
            showResults(data, 'å±æ€§æŸ¥è¯¢ç»“æœ');
        });
}

// ğŸ”˜ èŒƒå›´æŸ¥è¯¢ï¼šç‚¹å‡»æŒ‰é’®åè¿›å…¥ç»˜åˆ¶æ¨¡å¼
function startRangeQuery() {
    if (rectangleTool) {
        map.remove(rectangleTool);
        rectangleTool = null;
    }
    isSelecting = true;
    document.getElementById('rangeHint').style.display = 'block';
}

// æ¸…é™¤æ ‡è®°
function clearMarkers() {
    currentMarkers.forEach(m => m.setMap(null));
    currentMarkers = [];
    if (rectangleTool) {
        map.remove(rectangleTool);
        rectangleTool = null;
    }
    isSelecting = false;
    startPoint = null;
    document.getElementById('rangeHint').style.display = 'none';
}

// æ˜¾ç¤ºå±æ€§æŸ¥è¯¢ç»“æœ
function showResults(items, title) {
    let html = `<h5>${title} (${items.length} æ¡)</h5>`;
    if (items.length === 0) {
        html += '<p>æœªæ‰¾åˆ°åŒ¹é…ç»“æœã€‚</p>';
    } else {
        html += '<div class="list-group">';
        items.forEach(item => {
            html += `
                <div class="result-item">
                    <strong>${item.name}</strong><br>
                    <small>${item.type} Â· ${item.district}</small>
                </div>`;
        });
        html += '</div>';
    }
    document.getElementById('results').innerHTML = html;
}



// æš´éœ²å‡½æ•°ç»™å…¨å±€ï¼ˆä¾› onclick è°ƒç”¨ï¼‰
window.searchByKeyword = searchByKeyword;
window.clearMarkers = clearMarkers;

</script>
</body>
</html>